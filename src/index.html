<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>BROWSER CHECK</title>
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div id="warning-message" style="display: none">
      <div class="modal-header">
        <h4 class="modal-title" id="unsupported-browser-title">This Browser Is No Longer Supported!!!</h4>
      </div>
      <div class="modal-body">
        <p id="unsupported-browser-message">The browser version you are using is too old to run this application.</p>
        <p id="unsupported-browser-install">To continue using this application, you must install and use the latest version of one of the following browsers:</p>
        <hr />
        <div class="row my-4">
          <div class="col">
            <button
              class="btn btn-block btn-light"
              onclick="openLink('https://www.google.com/chrome/')"
            >
              <img
                src="assets/images/chrome.png"
                height="60px"
                alt="download Google Chrome"
              />
              <span style="white-space: nowrap">Google Chrome</span>
            </button>
          </div>
          <div class="col">
            <button
              class="btn btn-block btn-light"
              onclick="openLink('https://www.microsoft.com/edge')"
            >
              <img
                src="assets/images/edge.png"
                height="60px"
                alt="download Microsoft Edge"
              />
              <span style="white-space: nowrap">Microsoft Edge</span>
            </button>
          </div>
          <div class="col">
            <button
              class="btn btn-block btn-light"
              onclick="openLink('https://support.apple.com/en-us/HT204416')"
            >
              <img
                src="assets/images/safari.png"
                height="60px"
                alt="download Safari"
              />
              <span style="white-space: nowrap">Safari</span>
            </button>
          </div>
        </div>
        <a href="start.html">go to the angular app anyway</a>
      </div>
    </div>

    <script>
      /**
       * Opens a URL in a new window
       */
      function openLink(url) {
        window.open(url, "_blank");
      }

      /**
       * uses XMLHttpRequest to retrieve the translations file from the url provided
       * data via the resultHandler callback parameter
       *
       * @returns undefined; json data containing translated key/value pairs is
       * passed to the resultHandler callback function
       *
       */
      function fetchTranslations(url, errorHandler, resultHandler) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.responseType = "json";
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send();

        xhr.onload = function () {
          resultHandler(xhr.response);
        };

        xhr.onerror = function (e) {
          errorHandler(e);
        };

        xhr.onprogress = function (event) {
          // triggers periodically
          // event.loaded - how many bytes downloaded
          // event.lengthComputable = true if the server sent Content-Length header
          // event.total - total number of bytes (if lengthComputable)
          console.log("Received " + event.loaded + " of " + event.total);
        };
      }

      /**
       * validates the locale string
       * all translation file names follow the convention: xx-XX.json
       * so the locale string must match the 'xx-XX' format and it
       * must be one of the locales we support
       *
       * @returns boolean
       */
      function isValidLocale(locale) {
        var validLocales = ["en-US", "es-MX", "fr-CA"];
        var idx = -1;

        for (var i = 0; i < validLocales.length; ++i) {
          try {
            var foundMatch = validLocales[i].toLowerCase() === locale.toLowerCase();
            if (foundMatch) {
              idx = i;
              break;
            }
          } catch (e) {
            break;
          }
        }
        return idx > -1;
      }

      /**
       * get the user's preferred locale from either
       * 1) the cookie, or
       * 2) the browser's language setting
       *
       * @returns string
       */
      function getLocale(cookieName) {
        var searchFor = cookieName + "=";
        var cookies = document.cookie;
        var cookiesArr = document.cookie.split(";");
        for (var i = 0; i < cookiesArr.length; i++) {
          var cookie = cookiesArr[i];
          // strip out any/all leading spaces
          while (cookie.charAt(0) == " ") {
            cookie = cookie.substring(1);
          }
          if (cookie.indexOf(searchFor) == 0) {
            return cookie.substring(searchFor.length, cookie.length);
          }
        }
        var navLang = navigator.language;
        // this could potentially be a 2-letter code
        // or a locale code that we don't support so...

        return isValidLocale(navLang) ? navLang : "en-US";
      }

      /**
       * Retreives the translated string for the key provided
       * @returns string
       */
      function translate(key, translations) {
        return translations[key] || key;
      }

      /**
       * Inserts the text provided into the element with the id provided
       */
      function inject(text, id) {
        document.getElementById(id).innerText = text;
      }

      /**
       * displays the "old browser warning" markup
       * and populates the elements from translations if JSON is supported
       */
      function displayBrowserWarning(isJSONSupported) {
        if (isJSONSupported) {
          // display the translated text
          var locale = getLocale("locale");
          var url = "assets/i18n/" + locale + ".json";
          var errorHandler = function (error) {
            console.log(error);
          };
          var resultHandler = function (translationsJSON) {
            var title = translate("UNSUPPORTED_BROWSER", translationsJSON);
            var message = translate("UNSUPPORTED_BROWSER_TXT", translationsJSON);
            var install = translate("UNSUPPORTED_BROWSER_INSTALL", translationsJSON);

            inject(title, "unsupported-browser-title");
            inject(message, "unsupported-browser-message");
            inject(install, "unsupported-browser-install");
            document.getElementById("warning-message").style.display = "block";
          };

          fetchTranslations(url, errorHandler, resultHandler);
        } else {
          // rely on English-only version
          document.getElementById("warning-message").style.display = "block";
        }
      }

      /**
       * determines if the Angular app was properly bootstrapped in this browser
       * @returns boolean
       */
      function angularNotSupportedInThisBrowser() {
        // return document.querySelector("app-root[ng-version]") === undefined;
        return (
          typeof Promise === "undefined" ||
          typeof Map === "undefined" ||
          typeof Set === "undefined" ||
          typeof Object.assign === "undefined" ||
          typeof Symbol === "undefined" ||
          typeof JSON === "undefined"
        );
      }

      /**
       * called from body.onLoad to check browser features
       * displays the warning for unsupported browsers
       * redirects to the angular app for modern browsers
       */
      function handleOldBrowsers() {
        var isJSONSupported = typeof JSON !== "undefined" || !(navigator.userAgent.toLowerCase().indexOf('msie') > -1);
        console.log('isJSONSupported: ' + isJSONSupported);
        setTimeout(function () {
          if (angularNotSupportedInThisBrowser()) {
            var proceed = confirm(
              "your browser is old... go to angular app anyway?"
            );
            if (proceed) {
              // OK --- just to see what happens to old browsers that try to load an Angular 16 app
              window.location.href = "start.html";
            } else {
              // CANCEL --- display the warning
              displayBrowserWarning(isJSONSupported);
            }
          } else {
            var proceed = confirm(
              "your browser is modern... test translations anyway?"
            );
            if (proceed) {
              // OK --- just to test the old-style javascript in a modern browser
              displayBrowserWarning(isJSONSupported);
            } else {
              // CANCEL --- go to the Angular 16 app in your modern browser
              window.location.href = "start.html";
            }
          }
        });
      }
      document.addEventListener("DOMContentLoaded", handleOldBrowsers);
    </script>

    <!-- <script src="./index.js" type="text/javascript"></script> -->
  </body>
</html>
